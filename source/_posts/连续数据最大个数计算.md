---
title: 连续数据最大个数计算
comments: true
type: categories
categories: 数据库
tags:
  - 大数据
date: 2017-10-11
description:
---

### 连续数据最大个数计算

#### 建立测试数据

```sql
create table test_num

as

select 'a' id,1 num from dual

union all

select 'a' id,2 num from dual

union all

select 'a' id,3 num from dual

union all

select 'a' id,5 num from dual

union all

select 'a' id,6 num from dual

union all

select 'a' id,7 num from dual

union all

select 'b' id,1 num from dual

union all

select 'b' id,2 num from dual

union all

select 'b' id,5 num from dual

union all

select 'b' id,6 num from dual

union all

select 'b' id,7 num from dual

```



显示如图：

![1](https://ws4.sinaimg.cn/large/006tNbRwgy1fkf8wywfirj30ay08wdg0.jpg)



需要得到的结果应该是：

| id   | max（cn） |
| ---- | ------- |
| a    | 3       |
| b    | 3       |



#### 分析实现

数据连续，只要判断当前值和前一个值之间的差值是不是1就可以了，这一步通过分析函数lag 实现，要算连续的个数的话，可以对之前进行累加，如果数据是连续的，记为0，就是说之前的和是不变的，否则加1，再对和进行分组求总数，和的个数就是有几段是连续的，每一个和的个数就是在那一段连续的次数。



#### 最终代码实现：

```sql
select id,max(cn) from

(

select id,sum_num,count(1) cn from

(

select id,num,num2,gap,sum(gap) over(partition by id order by num) sum_num from

(

select id,num,num2,

case when num-num2=1 then 0 else 1 end gap from

(

select id,num,lag(num) over(partition by id order by num) num2 from

test_num

)t

)t2

)t3

group by id,sum_num

)t4

group by id

```
